# Error Handling

The goal is to have a secure and reliable system. This means errors that are not caused by a collaborator should be ignored and logged. One example are reply attacks or manipulating data.

Errors that are caused by a participant can't be recovered from and the document ends up in an error state.

## Receiving Data

### Snapshot

- `SECSYNC_ERROR_1`: decryption error -> throw an error
- `SECSYNC_ERROR_2`: current clients prev snapshot update was not included -> throw an error
- irrelevant message -> ignore and log

  - `SECSYNC_ERROR_3`: parse error of message (e.g. field is missing or added)
  - `SECSYNC_ERROR_4`: invalid signature (manipulated message)
  - `SECSYNC_ERROR_5`: invalid parentSnapshot verification
  - `SECSYNC_ERROR_6`: invalid docId

- `SECSYNC_ERROR_7`: getSnapshotKey error -> throw an error
- `SECSYNC_ERROR_8`: isValidCollaborator throws -> throw an error
- `SECSYNC_ERROR_9`: isValidCollaborator returns false -> ignore the message
- `SECSYNC_ERROR_10`: applySnapshot throws -> throw an error

### Update

- `SECSYNC_ERROR_11`: decryption error -> throw an error
- `SECSYNC_ERROR_12`: clock is > than + 2 - try to refetch and if not -> throw an error
- irrelevant message -> ignore and log

  - `SECSYNC_ERROR_13`: parse error of message (e.g. field is missing or added)
  - `SECSYNC_ERROR_14`: invalid signature (manipulated message)
  - `SECSYNC_ERROR_15`: invalid snapshotId reference, but valid message
  - `SECSYNC_ERROR_16`: clock is lower or equal then the received clock (reply attack)

- `SECSYNC_ERROR_17`: isValidCollaborator throws -> throw an error
- `SECSYNC_ERROR_18`: isValidCollaborator returns false -> ignore the message
- `SECSYNC_ERROR_19`: deserializeChanges throws -> throw an error
- `SECSYNC_ERROR_20`: applyChanges throws -> throw an error

### EphemeralMessages

When you receive an EphemeralMessage that is not valid it simply is ignored and stored in the `_ephemeralMessageReceivingErrors` array. To avoid a memory leak only the last 20 errors are stored.

- `SECSYNC_ERROR_21`: decryption error -> ignore
- `SECSYNC_ERROR_22`: no verified session -> ignore
- `SECSYNC_ERROR_23`: is not a verified collaborator
- `SECSYNC_ERROR_24`: invalid message type

## Sending Data

### Snapshot

Set the document to read only and show an error message to the user that the latest changes could not be synced.

- `SECSYNC_ERROR_25`: getNewSnapshotData error -> throw an error
- `SECSYNC_ERROR_26`: invalid context.signatureKeyPair -> throw an error
- `SECSYNC_ERROR_27`: hash, sign, encrypt error -> throw an error

Server:

snapshot-save-failed -> retry and if not set internal state that sync is not possible due a server issue

### Update

Set the document to read only and show an error message to the user that the latest changes could not be synced.

- `SECSYNC_ERROR_28`: serializeChanges error -> throw an error
- `SECSYNC_ERROR_29`: getSnapshotKey error -> throw an error
- `SECSYNC_ERROR_30`: getNewSnapshotData error -> throw an error
- `SECSYNC_ERROR_31`: invalid context.signatureKeyPair -> throw an error
- `SECSYNC_ERROR_32`: hash, sign, encrypt error -> throw an error

update-save-failed -> retry and if not set internal state that sync is not possible due a server issue

### EphemeralMessage

In case an error happens during the creation of an EphemeralMessage the error is ignored and stored in the `_ephemeralMessageAuthoringErrors` array. To avoid a memory leak only the last 20 errors are stored.

#### Error cases

- `SECSYNC_ERROR_33`: `getSnapshotKey` or signing or encrypting the EphemeralMessage throws an error
