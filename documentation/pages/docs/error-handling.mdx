# Error Handling

The goal is to have a secure and reliable system. This means errors that are not caused by a collaborator should be ignored and logged. One example are reply attacks or manipulating data.

Errors that are caused by a participant can't be recovered from and the document ends up in an error state.

## Receiving Data

### Snapshot

These errors result in an error state of the document and no new events are processed.

- `SECSYNC_ERROR_100`: Unknown Snapshot error.
- `SECSYNC_ERROR_101`: Decryption failed.
- `SECSYNC_ERROR_102`: The Snapshot did not include the update of prev confirmed update of the current client.
- `SECSYNC_ERROR_103`: callback `getSnapshotKey` threw an Error
- `SECSYNC_ERROR_104`: callback `isValidClient` threw an Error
- `SECSYNC_ERROR_105`: callback `applySnapshot` threw an Error

For these cases the error is ignored, logged and the document continues to work. Only in case this happens during loading the initial document the document ends up in an error state and no new events are processed.

- `SECSYNC_ERROR_110`: parse error of message (e.g. field is missing)
- `SECSYNC_ERROR_111`: Invalid signature
- `SECSYNC_ERROR_112`: Invalid parentSnapshot verification (can happend if snapshots come in out of order) -> refetch
- `SECSYNC_ERROR_113`: Invalid docId
- `SECSYNC_ERROR_114`: Callback `isValidClient` returns false

### Update

- `SECSYNC_ERROR_11`: decryption error -> throw an error
- `SECSYNC_ERROR_12`: clock is > than + 2 - try to refetch and if not -> throw an error
- irrelevant message -> ignore and log

  - `SECSYNC_ERROR_13`: parse error of message (e.g. field is missing or added)
  - `SECSYNC_ERROR_14`: invalid signature (manipulated message)
  - `SECSYNC_ERROR_15`: invalid snapshotId reference, but valid message
  - `SECSYNC_ERROR_16`: clock is lower or equal then the received clock (reply attack)

- `SECSYNC_ERROR_17`: isValidClient throws -> throw an error
- `SECSYNC_ERROR_18`: isValidClient returns false -> ignore the message
- `SECSYNC_ERROR_19`: deserializeChanges throws -> throw an error
- `SECSYNC_ERROR_20`: applyChanges throws -> throw an error

### EphemeralMessages

When you receive an EphemeralMessage that is not valid it simply is ignored and stored in the `_ephemeralMessageReceivingErrors` array. To avoid a memory leak only the last 20 errors are stored.

- `SECSYNC_ERROR_300`: Unknown EphemeralMessage error.
- `SECSYNC_ERROR_301`: Decryption failed.
- `SECSYNC_ERROR_302`: No verified session found.
- `SECSYNC_ERROR_303`: A messages was received where the counter was not higher than the last received message. (reply attack)
- `SECSYNC_ERROR_304`: The author is not a valid client.
- `SECSYNC_ERROR_305`: The message type is not supported.
- `SECSYNC_ERROR_306`: A message with the wrong docId was received.
- `SECSYNC_ERROR_307`: The message was manipulated and has not the correct shape.
- `SECSYNC_ERROR_308`: Message signature is not valid.

## Sending Data

### Snapshot

Set the document to read only and show an error message to the user that the latest changes could not be synced.

- `SECSYNC_ERROR_27`: getNewSnapshotData error -> throw an error
- `SECSYNC_ERROR_28`: invalid context.signatureKeyPair -> throw an error
- `SECSYNC_ERROR_29`: hash, sign, encrypt error -> throw an error

Server:

snapshot-save-failed -> retry and if not set internal state that sync is not possible due a server issue

### Update

Set the document to read only and show an error message to the user that the latest changes could not be synced.

- `SECSYNC_ERROR_30`: serializeChanges error -> throw an error
- `SECSYNC_ERROR_31`: getSnapshotKey error -> throw an error
- `SECSYNC_ERROR_32`: getNewSnapshotData error -> throw an error
- `SECSYNC_ERROR_33`: invalid context.signatureKeyPair -> throw an error
- `SECSYNC_ERROR_34`: hash, sign, encrypt error -> throw an error

update-save-failed -> retry and if not set internal state that sync is not possible due a server issue

### EphemeralMessage

In case an error happens during the creation of an EphemeralMessage the error is ignored and stored in the `_ephemeralMessageAuthoringErrors` array. To avoid a memory leak only the last 20 errors are stored.

#### Error cases

- `SECSYNC_ERROR_35`: `getSnapshotKey` or signing or encrypting the EphemeralMessage throws an error
